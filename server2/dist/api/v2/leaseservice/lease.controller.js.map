{"version":3,"sources":["../../../../src/api/v2/leaseservice/lease.controller.js"],"names":["leaseController","dotenv","require","config","fetch","Order","Orderstat","Userkey","errorhandler","eosaction","PrivateKey","PublicKey","Signature","Aes","key_utils","createClient","client","dspEndpt","getClient","network","httpEndpoint","create","req","res","status","send","register_user","body","lease_amount","lease_period","vote_choice","account_name","message","service","process","env","contract","prv_key","randomKey","toWif","console","log","pubkey","fromString","toPublic","toString","response_reg","push_liquid_account_transaction","vaccount","response_registeraction","balance","userkeys","user","private","public","save","err","errmsg","smartcontracterr","create_order","authorizer","stake_to","rent_amount","rent_offer","duration","resource_type","orderid","getid","data","id","result","pushtrx","order","order_id","order_stat","apr","parseFloat","split","orderobj","lease_transfer","amount","from","exchange","to","quantity","memo","match_order","orders","aggregate","$match","$sort","vaccount_det","getvaccountdet","row","flag","duration_lease","every","element","index","max_lease_period","order_stat_id","getorderstatid","orderstat_id","changeorderstat","filled_at","Date","setDate","getDate","orderstat","lender","rent_fee","expires_at","toISOString","ordderstatres","withdraw","findOne","cancelorder","remove","exec","leaseunstake","get_orderdet","params","find","get_orderstatdet","get_orderstatdet_byaccount","respobj","vaccount_blc","liquid_blc","total_leaseout_amount","total_rewards_amount","total_reward_amount","order_matched","get_accountblc","vaccount_history","getvaccounthistory","userblc_leaseout","userblc_totalstaked","userblc_totalreward","userblc_leaseout_history"],"mappings":"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","file":"lease.controller.js","sourcesContent":["let leaseController = {}\nconst dotenv = require('dotenv')\ndotenv.config()\nconst fetch = require('isomorphic-fetch')\n\nconst Order = require('./model/order.model')\nconst Orderstat = require('./model/orderstatus.model')\nconst Userkey = require('./model/userkeys.model')\nconst errorhandler = require('./errorhandler')\nconst eosaction = require('./eosaction/eosaction')\nlet {\n  PrivateKey,\n  PublicKey,\n  Signature,\n  Aes,\n  key_utils,\n  config\n} = require('eosjs-ecc')\nconst { createClient } = require('@liquidapps/dapp-client')\nvar client\nlet dspEndpt = 'https://kylin-dsp-2.liquidapps.io'\nconst getClient = async () => {\n  if (client) return client\n  client = await createClient({\n    network: 'kylin',\n    httpEndpoint: dspEndpt,\n    fetch: fetch\n  })\n  return client\n}\n\nleaseController.create = (req, res) => {\n  res.status(200).send('create user')\n}\n\nleaseController.register_user = async (req, res) => {\n  if (\n    !req.body.lease_amount ||\n    !req.body.lease_period ||\n    !req.body.vote_choice ||\n    !req.body.account_name\n  ) {\n    return res.status(400).send({ message: 'Missing required body parameter' })\n  }\n  try {\n    // let client = await createClient({\n    //   network: 'kylin',\n    //   httpEndpoint: dspEndpt,\n    //   fetch: fetch\n    // })\n    const service = await (await getClient()).service('vaccounts', process.env.contract)\n    let prv_key = await PrivateKey.randomKey()\n    prv_key = prv_key.toWif()\n    console.log(prv_key)\n    let pubkey = PrivateKey.fromString(prv_key)\n      .toPublic()\n      .toString()\n    console.log(pubkey)\n    const response_reg = await service.push_liquid_account_transaction(\n      process.env.contract,\n      prv_key,\n      'regaccount',\n      {\n        vaccount: req.body.account_name // process.env.user1 // increment to new account if fails\n      }\n    )\n    console.log('response_reg', response_reg)\n\n    const response_registeraction = await service.push_liquid_account_transaction(\n      process.env.contract,\n      prv_key,\n      'registeracc',\n      {\n        vaccount: req.body.account_name, // process.env.user1,\n        balance: req.body.lease_amount,\n        lease_period: req.body.lease_period,\n        vote_choice: req.body.vote_choice\n      }\n    )\n    console.log('response_registeraction', response_registeraction)\n    let userkeys = new Userkey()\n    userkeys.user = req.body.account_name\n    userkeys.private = prv_key\n    userkeys.public = pubkey\n    await userkeys.save()\n    return res.status(200).send({ message: 'Successful' })\n    // lease_transfer(req.body.lease_amount);\n  } catch (err) {\n    let errmsg = await errorhandler.smartcontracterr(err)\n    return res.status(400).send(errmsg)\n  }\n}\n\nleaseController.create_order = async (req, res) => {\n  if (\n    !req.body.authorizer ||\n    !req.body.stake_to ||\n    !req.body.rent_amount ||\n    !req.body.rent_offer ||\n    !req.body.duration ||\n    !req.body.resource_type\n  ) {\n    return res.status(400).send({ message: 'Missing required body parameter' })\n  }\n\n  try {\n    let orderid = await eosaction.getid()\n    console.log('oreid received ==', orderid)\n    let data = {\n      id: orderid,\n      authorizer: req.body.authorizer,\n      stake_to: req.body.stake_to,\n      rent_amount: req.body.rent_amount,\n      rent_offer: req.body.rent_offer,\n      duration: req.body.duration,\n      resource_type: req.body.resource_type\n    }\n    const result = await eosaction.pushtrx(\n      'createorder',\n      data,\n      process.env.contract,\n      process.env.contract\n    )\n    console.log('result', result)\n\n    let order = new Order()\n    order.order_id = orderid\n    order.authorizer = req.body.authorizer\n    order.stake_to = req.body.stake_to\n    order.rent_amount = req.body.rent_amount\n    order.rent_offer = req.body.rent_offer\n    order.lease_period = req.body.duration\n    order.resource_type = req.body.resource_type\n    order.order_stat = 'queue'\n    order.apr =\n      parseFloat(req.body.rent_offer.split(' ')[0]) /\n      parseFloat(req.body.duration)\n\n    let orderobj = await order.save()\n    console.log('orderobj', orderobj)\n    return res.status(200).send({ message: orderobj })\n  } catch (err) {\n    let errmsg = await errorhandler.smartcontracterr(err)\n    return res.status(400).send(errmsg)\n  }\n}\n\nleaseController.lease_transfer = async (req, res) => {\n  if (!req.body.amount || !req.body.account_name) {\n    return res.status(400).send({ message: 'Missing required body parameter' })\n  }\n  try {\n    let data = {\n      from: process.env.exchange,\n      to: process.env.contract,\n      quantity: req.body.amount,\n      memo: '1:' + req.body.account_name\n    }\n    const result = await eosaction.pushtrx(\n      'transfer',\n      data,\n      'eosio.token',\n      process.env.exchange\n    )\n    console.log('result', result)\n    return res.status(200).send({ message: 'Successfully transferred' })\n  } catch (err) {\n    let errmsg = await errorhandler.smartcontracterr(err)\n    return res.status(400).send(errmsg)\n  }\n}\n\nleaseController.match_order = async (req, res) => {\n  if (!req.body.account_name) {\n    return res.status(400).send({ message: 'Missing required body parameter' })\n  }\n\n  try {\n    let orders = await Order.aggregate([\n      { $match: { order_stat: 'queue' } },\n      { $sort: { apr: -1 } }\n    ])\n\n    let vaccount_det = await eosaction.getvaccountdet(req.body.account_name)\n    if (!vaccount_det.row) {\n      return res.status(400).send({ message: 'No vaccount found' })\n    }\n    console.log('orders, vaccounts =', orders, vaccount_det)\n    let orderid = 0\n    let flag = 0\n    let duration_lease = 0\n    orders.every(function (element, index) {\n      console.log('element', element)\n\n      if (\n        element.lease_period <= vaccount_det.row.max_lease_period &&\n        parseFloat(element.rent_amount.split(' ')[0]) <=\n          parseFloat(vaccount_det.row.balance.split(' ')[0])\n      ) {\n        orderid = element.order_id\n        duration_lease = element.lease_period\n        flag = 1\n        return false\n      } else return true\n    })\n    console.log('flag ==', flag)\n    console.log('id selected received ==', orderid)\n    if (flag == 1) {\n      let order_stat_id = await eosaction.getorderstatid()\n      console.log('id received==', order_stat_id)\n      //\n      // console.log(\"orderobj\",orderobj)\n      // if (orderobj) {\n      let data = {\n        vaccount: req.body.account_name,\n        id: orderid,\n        orderstat_id: order_stat_id\n      }\n      const result = await eosaction.pushtrx(\n        'checkorder',\n        data,\n        process.env.contract,\n        process.env.contract\n      )\n      console.log('trx =', result)\n      let orderobj = await eosaction.changeorderstat(orderid)\n      let filled_at = new Date()\n      let duration = filled_at.setDate(filled_at.getDate() + duration_lease)\n\n      let orderstat = new Orderstat()\n      orderstat.orderstat_id = order_stat_id\n      orderstat.order_id = orderid\n      orderstat.lender = req.body.account_name\n      orderstat.authorizer = orderobj.authorizer\n      orderstat.stake_to = orderobj.stake_to\n      orderstat.rent_amount = orderobj.rent_amount\n      orderstat.rent_fee = orderobj.rent_offer\n      orderstat.expires_at = new Date(duration).toISOString().split('.')[0]\n      orderstat.filled_at = new Date().toISOString().split('.')[0]\n\n      let ordderstatres = await orderstat.save()\n      return res.status(200).send({message : ordderstatres})\n      // }\n    } else {\n      return res\n        .status(200)\n        .send({ message: 'At present no match found for this lease request' })\n    }\n  } catch (err) {\n    let errmsg = await errorhandler.smartcontracterr(err)\n    return res.status(400).send(errmsg)\n  }\n}\n\nleaseController.withdraw = async (req, res) => {\n  if (!req.body.account_name) {\n    return res.status(400).send({ message: 'Missing required body parameter' })\n  }\n  try {\n    let client = await createClient({\n      network: 'kylin',\n      httpEndpoint: dspEndpt,\n      fetch: fetch\n    })\n    const service = await client.service('vaccounts', process.env.contract)\n\n    let userkeys = await Userkey.findOne({ user: req.body.account_name })\n    console.log(userkeys)\n    if (userkeys != null) {\n      const response_registeraction = await service.push_liquid_account_transaction(\n        process.env.contract,\n        userkeys.private,\n        'withdraw',\n        {\n          vaccount: req.body.account_name // process.env.user1,\n        }\n      )\n      console.log('response_registeraction', response_registeraction)\n      return res\n        .status(200)\n        .send({ message: 'Successfully withdrawn lease-out request' })\n    } else {\n      return res\n        .status(400)\n        .send({ message: 'No private key found for this vaccount' })\n    }\n  } catch (err) {\n    let errmsg = await errorhandler.smartcontracterr(err)\n    return res.status(400).send(errmsg)\n  }\n}\n\nleaseController.cancelorder = async (req, res) => {\n  if (!req.body.order_id) {\n    return res.status(400).send({ message: 'Missing required body parameter' })\n  }\n  try {\n    let data = {\n      orderid: req.body.order_id\n    }\n    const result = await eosaction.pushtrx(\n      'cancelorder',\n      data,\n      process.env.contract,\n      process.env.contract\n    )\n    console.log('result', result)\n    let order = await Order.findOne({ order_id: req.body.order_id })\n      .remove()\n      .exec()\n\n    return res\n      .status(200)\n      .send({ message: 'Successfully withdrawn order request' })\n  } catch (err) {\n    let errmsg = await errorhandler.smartcontracterr(err)\n    return res.status(400).send(errmsg)\n  }\n}\n\nleaseController.leaseunstake = async (req, res) => {\n  if (!req.body.order_stat_id) {\n    return res.status(400).send({ message: 'Missing required body parameter' })\n  }\n  try {\n    let data = {\n      orderid: req.body.order_stat_id\n    }\n    const result = await eosaction.pushtrx(\n      'leaseunstake',\n      data,\n      process.env.contract,\n      process.env.contract\n    )\n    console.log('result', result)\n    let order = await Orderstat.findOne({ id: req.body.order_stat_id })\n    if (order) {\n      await Order.findOne({ order_id: order.order_id })\n        .remove()\n        .exec()\n      await order.remove()\n      return res.status(200).send({message : 'Successfully unstaked'})\n    }\n  } catch (err) {\n    let errmsg = await errorhandler.smartcontracterr(err)\n    return res.status(400).send(errmsg)\n  }\n}\n\nleaseController.get_orderdet = async (req, res) => {\n  if (!req.params.authorizer) {\n    return res.status(400).send({ message: 'Missing required parameter' })\n  }\n  try {\n    let order = await Order.find({ authorizer: req.params.authorizer })\n    if (order) {\n      return res.status(200).send({message : order})\n    } else {\n      return res.status(400).send({ message: 'no order created by this account name' })\n    }\n  } catch (err) {\n    let errmsg = await errorhandler.smartcontracterr(err)\n    return res.status(400).send(errmsg)\n  }\n}\n\nleaseController.get_orderstatdet = async (req, res) => {\n  try {\n    let orderstat = await Orderstat.find({})\n    if (orderstat) {\n      return res.status(200).send({message : orderstat})\n    } else {\n      return res.status(400).send({ message: 'no order status details found' })\n    }\n  } catch (err) {\n    let errmsg = await errorhandler.smartcontracterr(err)\n    return res.status(400).send(errmsg)\n  }\n}\n\nleaseController.get_orderstatdet_byaccount = async (req, res) => {\n  if (!req.params.account_name) {\n    return res.status(400).send({ message: 'Missing required parameter' })\n  }\n  try {\n    let orderstat = await Orderstat.find({lender : req.params.account_name})\n    if (orderstat) {\n    let respobj = {}\n      let vaccount_blc = await eosaction.getvaccountdet(req.params.account_name)\n  \n      if(vaccount_blc.row)\n      {\n        respobj.liquid_blc = vaccount_blc.row.balance,\n        respobj.total_leaseout_amount = vaccount_blc.row.total_leaseout_amount\n        respobj.total_rewards_amount = vaccount_blc.row.total_reward_amount\n      }\n      respobj.order_matched = orderstat\n     \n     \n      return res.status(200).send({message : respobj})\n    } else {\n      return res.status(400).send({ message: 'no order matched yet for this account_name' })\n    }\n  } catch (err) {\n    let errmsg = await errorhandler.smartcontracterr(err)\n    return res.status(400).send(errmsg)\n  }\n}\n\nleaseController.get_accountblc = async (req, res) => {\n  if (!req.params.vaccount) {\n    return res.status(400).send({ message: 'Missing required parameter' })\n  }\n  try {\n    let vaccount_blc = await eosaction.getvaccountdet(req.params.vaccount)\n    let vaccount_history = await eosaction.getvaccounthistory(\n      req.params.vaccount\n    )\n    let respobj = {}\n    if (vaccount_blc.row) {\n      respobj.userblc_leaseout = vaccount_blc.row.balance\n      respobj.userblc_totalstaked = vaccount_blc.row.total_leaseout_amount\n      respobj.userblc_totalreward = vaccount_blc.row.total_reward_amount\n    } else if (vaccount_history.row) {\n      respobj.userblc_leaseout_history = vaccount_history.row.balance\n    } else respobj.userblc_leaseout = '0.0000 EOS'\n    return res.status(200).send({message : respobj})\n  } catch (err) {\n    let errmsg = await errorhandler.smartcontracterr(err)\n    return res.status(400).send(errmsg)\n  }\n}\n\nexport default leaseController\n/// //////////////\n"]}