{"version":3,"sources":["../../../../../src/api/v2/leaseservice/eosaction/eosaction.js"],"names":["pushtrx","getid","getorderstatid","changeorderstat","getvaccountdet","getvaccounthistory","updateexchange","getcurrencybalance","dotenv","require","config","rp","Api","JsonRpc","RpcError","JsSignatureProvider","fetch","TextEncoder","TextDecoder","Order","Orderstat","Ordercounter","Orderstatcounter","Userbalance","signatureProvider","process","env","contract_key","proxy1_key","proxy2_key","exchange_key","dspEndpt","rpc","api","textDecoder","textEncoder","method","data","account","actor","result","transact","actions","name","authorization","permission","blocksBehind","expireSeconds","res","find","console","log","length","orderid","order_id","save","id","orderstatid","orderstat_id","findOne","order_stat","vaccount","dataString1","contract","vaccount_table","options","url","get_table_row","body","JSON","parse","err","vaccount_history","account_name","amount","operation","user","blc","parseFloat","balance","split","toFixed","toString","lease_out","get_currency_balance","exchange","exchngeblc"],"mappings":"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","file":"eosaction.js","sourcesContent":["const dotenv = require('dotenv')\ndotenv.config()\nvar rp = require('request-promise')\nconst { Api, JsonRpc, RpcError } = require('eosjs')\nconst { JsSignatureProvider } = require('eosjs/dist/eosjs-jssig')\nconst fetch = require('isomorphic-fetch')\nconst { TextEncoder, TextDecoder } = require('text-encoding')\n\nconst Order = require('../model/order.model')\nconst Orderstat = require('../model/orderstatus.model')\nconst Ordercounter = require('../model/orderidcounter.model')\nconst Orderstatcounter = require('../model/orderstatcounter.model')\nconst Userbalance = require('../model/userexchangeblc.model')\n\nconst signatureProvider = new JsSignatureProvider([\n  process.env.contract_key,\n  process.env.proxy1_key,\n  process.env.proxy2_key,\n  process.env.exchange_key\n])\nlet dspEndpt = 'https://kylin-dsp-2.liquidapps.io'\nlet rpc = new JsonRpc(dspEndpt, { fetch })\nlet api = new Api({\n  rpc,\n  signatureProvider,\n  textDecoder: new TextDecoder(),\n  textEncoder: new TextEncoder()\n})\n\nexport async function pushtrx (method, data, account, actor) {\n    const result = await api.transact(\n      {\n        actions: [\n          {\n            account: account,\n            name: method,\n            authorization: [\n              {\n                actor: actor,\n                permission: 'active'\n              }\n            ],\n            data: data\n          }\n        ]\n      },\n      {\n        blocksBehind: 3,\n        expireSeconds: 30\n      }\n    )\n   \n    return result\n \n}\n\nexport async function getid () {\n  let res = await Ordercounter.find()\n  console.log(\"ghg\",res[0])\n  if (res.length == 0) {\n    let orderid = new Ordercounter()\n    orderid.order_id = 111\n    await orderid.save()\n    return 111\n  } else {\n    let id = res[0].order_id\n   \n    res[0].order_id += 1\n    res[0].save() \n    return ++id\n  }\n}\n\nexport async function getorderstatid () {\n  let res = await Orderstatcounter.find()\n  if (res.length == 0) {\n    let orderstatid = new Orderstatcounter()\n    orderstatid.orderstat_id = 222\n    await orderstatid.save()\n    return 222\n  } else {\n    let id = res[0].orderstat_id\n   \n    res[0].orderstat_id += 1\n    res[0].save() \n    return ++id\n  }\n}\n\nexport async function changeorderstat (orderid) {\n  let res = await Order.findOne({ order_id: orderid })\n\n  if (res==null) {\n    return 0\n  } else {\n    res.order_stat = 'active'\n    await res.save()\n    return res\n  }\n}\n\nexport async function getvaccountdet (vaccount) {\n\n  try{\n    var dataString1 =\n    '{\"contract\":\"' +\n    process.env.contract +\n    '\",\"scope\":\"' +\n    process.env.contract +\n    '\",\"table\":\"' +\n    process.env.vaccount_table +\n    '\",\"key\":\"' +\n    vaccount +\n    '\"}'\n  var options = {\n    url: process.env.get_table_row,\n    method: 'POST',\n    body: dataString1\n  }\n \n  let res = await rp(options)\n  res = JSON.parse(res)\n  return res\n  } catch(err)\n  {\n    let res = {}\n    return res\n  }\n  \n}\n\nexport async function getvaccounthistory (vaccount) {\n  try {\n  var dataString1 =\n    '{\"contract\":\"' +\n    process.env.contract +\n    '\",\"scope\":\"' +\n    process.env.contract +\n    '\",\"table\":\"' +\n    process.env.vaccount_history +\n    '\",\"key\":\"' +\n    vaccount +\n    '\"}'\n  var options = {\n    url: process.env.get_table_row,\n    method: 'POST',\n    body: dataString1\n  }\n \n  let res = await rp(options)\n  res = JSON.parse(res)\n  return res\n} catch(err)\n{\n  let res = {}\n  return res\n}\n}\n\nexport async function updateexchange (account_name, amount, operation) {\n  try {\n    let res = await Userbalance.findOne({ user: account_name })\n    console.log(\"response1==\",res)\n    if (operation == 'transfer') {\n     \n      if (res!=null) {\n        \n        let blc =\n          parseFloat(res.balance.split(' ')[0]) -\n          parseFloat(amount.split(' ')[0])\n        res.balance = blc.toFixed(4).toString() + ' EOS'\n        res.lease_out =\n          (\n            parseFloat(res.lease_out.split(' ')[0]) +\n            parseFloat(amount.split(' ')[0])\n          )\n            .toFixed(4)\n            .toString() + ' EOS'\n        await res.save()\n      } else {\n        let balance = await api.rpc.get_currency_balance(\n          \"eosio.token\",\n          process.env.exchange,\n          \"EOS\"\n        )\n        console.log(\"currency balance=\",balance[0])\n        if(!balance) balance = \"0.0000 EOS\" \n        else balance = balance[0]\n\n        let exchngeblc = new Userbalance()\n        exchngeblc.user = account_name\n        exchngeblc.balance = balance\n        exchngeblc.lease_out = amount\n        exchngeblc.save()\n      }\n    } else if (operation == 'withdraw') {\n      console.log(\"else\")\n      if (res!=null) {\n        let balance = await api.rpc.get_currency_balance(\n          'eosio.token',\n          process.env.exchange,\n          \"EOS\"\n        )\n        if(balance)\n        {\n        res.balance = balance[0]\n        res.lease_out = '0.0000 EOS'\n        await res.save()\n        }\n        \n      }\n    }\n  } catch (err) {\n    console.log(\"error--\",err)\n  }\n}\n\nexport async function getcurrencybalance (account) {\n  let balance = await api.rpc.get_currency_balance(\n    'eosio.token',\n    process.env.exchange,\n    \"EOS\"\n  )\n\n  return balance\n}\n"]}